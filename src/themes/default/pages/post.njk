{% extends "layouts/base.njk" %}

{% block content %}
{# Note: The logic for SEO tags (svelte:head) must be handled by the ThemeRenderer
   passing data up, or we render them in the base layout based on context.
   For now, we assume the Svelte +page.svelte handles the Head metadata before rendering this.
   (Wait, ThemeRenderer renders INSIDE the body usually, so Head management needs to be thought through.
    But let's focus on the body content first).
#}

{# Check if post exists #}
{% if post %}
    {# ReadingProgressBar component #}
    {{ component('ReadingProgressBar') | safe }}

    <div class="relative mx-auto flex max-w-screen-xl px-4 py-8">
        <!-- Main Article Content -->
        <div class="flex-1 min-w-0 max-w-prose mx-auto">
            <div class="mb-8">
                <a href="/" class="article-back">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path d="m15 18-6-6 6-6" />
                    </svg>
                    Back to home
                </a>

                <div class="article-meta flex flex-wrap items-center gap-x-2 gap-y-1">
                    {# Custom filters like 'date_standard' need to be added to engine #}
                    <span>By {{ post.author_name }} on {{ post.published_at | date_standard }}</span>

                    {% if post.category_name %}
                        <span>· {{ post.category_name }}</span>
                    {% endif %}

                    {% if post.reading_time %}
                        <span>· {{ post.reading_time }} min read</span>
                    {% endif %}

                    <span>·</span>
                    {# ViewCounter component #}
                    {{ component('ViewCounter', { slug: post.slug, initialViews: post.view_count or 0 }) | safe }}
                </div>

                <h1 class="article-title">{{ post.title }}</h1>

                {% if post.excerpt %}
                    <p class="text-lg text-muted-foreground mb-6">{{ post.excerpt }}</p>
                {% endif %}
            </div>

            <div class="article-body">
                {# The sanitizedContent is passed in the context.
                   Nunjucks escapes by default, so we use safe. #}
                {{ sanitizedContent | safe }}
            </div>
        </div>

        <!-- Table of Contents Sidebar -->
        {# toc and activeHeadingId are passed in context #}
        {% if toc.length > 0 %}
             {{ component('TableOfContents', { toc: toc, activeHeadingId: activeHeadingId }) | safe }}
        {% endif %}
    </div>

    {# MobileArticleNav component #}
    {{ component('MobileArticleNav', { title: post.title, toc: toc, activeHeadingId: activeHeadingId }) | safe }}

{% else %}
    <!-- Fallback for when post is null -->
    <div class="relative mx-auto flex max-w-screen-xl px-4 py-8 text-center text-lg text-muted-foreground">
        <p>Post not found. Please check the URL.</p>
    </div>
{% endif %}
